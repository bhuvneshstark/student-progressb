<div class="table-container" id="output"></div>
<canvas id="progressChart"></canvas>

<script>
let chart;
let allRecords = [];

function findKey(obj, key) {
  return Object.keys(obj).find(k => k.trim().toLowerCase() === key.toLowerCase());
}

function formatDate(d) {
  const dt = new Date(d);
  return isNaN(dt) ? d : dt.toLocaleDateString("en-GB", { day: "2-digit", month: "short", year: "numeric" });
}

// Search function
async function searchData() {
  const query = document.getElementById("search").value.trim();
  const output = document.getElementById("output");
  output.innerHTML = "";

  // Remove previous chart
  if (chart) {
    chart.destroy();
    chart = null;
  }

  if (!query) {
    output.innerHTML = "<div class='no-data'>Please enter a Name or Email</div>";
    return;
  }

  const response = await fetch(`${API_URL}?q=${encodeURIComponent(query)}`);
  const data = await response.json();

  if (!data || data.length === 0) {
    output.innerHTML = "<div class='no-data'>No results found</div>";
    return;
  }

  allRecords = data;
  const dateKey = findKey(allRecords[0], "date");
  const nameKey = findKey(allRecords[0], "name");
  const emailKey = findKey(allRecords[0], "email");

  const studentName = data[0][nameKey] || "";
  const studentEmail = data[0][emailKey] || "";

  // Build table with date dropdown in Date column
  const uniqueDates = [...new Set(allRecords.map(r => r[dateKey]))].filter(Boolean);

  const html = `
    <table>
      <thead>
        <tr>
          <th>Date</th>
          <th>Name</th>
          <th>Email</th>
          <th>Total Classes</th>
          <th>Physics</th>
          <th>Chemistry</th>
          <th>Maths</th>
          <th>Tests</th>
          <th>Study Hours</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td>
            <select id="dateSelectTable" onchange="updateTableAndChart(this.value)">
              <option value="">-- Choose Date --</option>
              ${uniqueDates.map(d => `<option value="${d}">${formatDate(d)}</option>`).join('')}
            </select>
          </td>
          <td>${studentName}</td>
          <td>${studentEmail}</td>
          <td id="totalClasses">0</td>
          <td id="physics">0</td>
          <td id="chemistry">0</td>
          <td id="maths">0</td>
          <td id="tests">0</td>
          <td id="studyHours">0</td>
        </tr>
      </tbody>
    </table>
  `;

  output.innerHTML = html;
}

// Update table row and chart when a date is selected
function updateTableAndChart(selectedDate) {
  if (!selectedDate) return;

  const dateKey = findKey(allRecords[0], "date");
  const row = allRecords.find(r => r[dateKey] === selectedDate);
  if (!row) return;

  // Update table values
  document.getElementById("totalClasses").innerText = row[findKey(row, "total classes attended")] || 0;
  document.getElementById("physics").innerText = row[findKey(row, "physics questions attempted")] || 0;
  document.getElementById("chemistry").innerText = row[findKey(row, "chemistry questions attempted")] || 0;
  document.getElementById("maths").innerText = row[findKey(row, "maths questions attempted")] || 0;
  document.getElementById("tests").innerText = row[findKey(row, "total tests taken")] || 0;
  document.getElementById("studyHours").innerText = row[findKey(row, "study hours")] || 0;

  // Update chart
  const chartCanvas = document.getElementById("progressChart").getContext("2d");
  const chartData = {
    labels: ["Total Classes", "Physics", "Chemistry", "Maths", "Tests", "Study Hours"],
    datasets: [{
      label: "Student Progress",
      data: [
        Number(row[findKey(row, "total classes attended")] || 0),
        Number(row[findKey(row, "physics questions attempted")] || 0),
        Number(row[findKey(row, "chemistry questions attempted")] || 0),
        Number(row[findKey(row, "maths questions attempted")] || 0),
        Number(row[findKey(row, "total tests taken")] || 0),
        Number(row[findKey(row, "study hours")] || 0)
      ],
      backgroundColor: ["#007bff","#28a745","#ffc107","#dc3545","#17a2b8","#6f42c1"],
      borderRadius: 6
    }]
  };

  const options = {
    responsive: true,
    plugins: {
      legend: { display: false },
      title: { display: true, text: `Progress (${formatDate(selectedDate)})`, font: { size: 18 } }
    },
    scales: { y: { beginAtZero: true } }
  };

  if (chart) chart.destroy();
  chart = new Chart(chartCanvas, { type: 'bar', data: chartData, options });
}
</script>













